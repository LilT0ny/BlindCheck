events {}

http {
    server {
        listen 80;
        server_name blindcheck.space www.blindcheck.space;

        # Para renovaciones automáticas de Certbot
        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        # Redirección global a HTTPS
        location / {
            return 301 https://$host$request_uri;
        }
    }

    server {
        listen 443 ssl;
        server_name blindcheck.space www.blindcheck.space;

        # Rutas de los certificados
        ssl_certificate /etc/letsencrypt/live/blindcheck.space/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/blindcheck.space/privkey.pem;

        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

        # --- ROUTING ---

        # 1. Frontend
        location / {
            proxy_pass http://blindcheck-frontend:80;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # 2. Auth Service
        location /api/auth/ {
            proxy_pass http://auth-service:8000/api/auth/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # 3. Student Service
        location /api/estudiante/ {
            proxy_pass http://student-service:8000/api/estudiante/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # 4. Teacher Service
        location /api/docente/ {
            proxy_pass http://teacher-service:8000/api/docente/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # 5. Admin Service
        location /api/subdecano/ {
            proxy_pass http://admin-service:8000/api/subdecano/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # 6. Uploads (Served directly or proxied?)
        # For simplicity, let's serve from volume if possible. 
        # But Proxying to 'student' service (or any service that mounts it) works too.
        # Let's serve it directly from Nginx Gateway as it will mount the volume.
        location /uploads/ {
            alias /app/uploads/;
        }
    }
}
