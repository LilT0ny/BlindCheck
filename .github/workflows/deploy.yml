name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            # 1. Navegar al directorio y asegurar permisos
            cd ~/BlindCheck || exit 1
            sudo chown -R $USER:$USER ~/BlindCheck

            # 2. Detener servicios externos que chocan con puertos 80/443
            echo "Stopping conflicting services..."
            sudo systemctl stop nginx 2>/dev/null || true
            sudo systemctl stop apache2 2>/dev/null || true

            # 3. Actualizar c√≥digo (Limpia cambios locales accidentales)
            echo "Syncing with GitHub..."
            git fetch --all
            git reset --hard origin/main

            # 4. Limpieza Profunda de Docker (Evita que el disco se llene)
            echo "Cleaning up Docker environment..."
            docker compose down --remove-orphans
            # Borra im√°genes viejas de m√°s de 24h para liberar espacio
            docker image prune -a -f --filter "until=24h"
            # Borra cach√© de construcci√≥n para liberar m√°s espacio
            docker builder prune -f



            # 5. Gesti√≥n de Certificados SSL (Manual - ver init-letsencrypt.sh)
            # El paso de generaci√≥n autom√°tica se ha eliminado para evitar bloqueos de Let's Encrypt.
            # Los certificados se persisten en el servidor en ./certbot
            if [ -d "./certbot/conf/live/blindcheck.space" ]; then
               echo "‚úÖ SSL: Certificados detectados."
            else
               echo "‚ö†Ô∏è SSL: No se detectaron certificados. RECUERDA: Ejecutar ./init-letsencrypt.sh manualmente en el servidor la primera vez."
            fi

            # 6. Despliegue y Re-construcci√≥n
            echo "üöÄ Lanzando contenedores..."
            docker compose up -d --build

            # 7. Verificaci√≥n de salud y Logs de error
            echo "Final verification..."
            sleep 10
            docker compose ps
            
            # Si el frontend no sube, nos muestra el error en los logs de GitHub
            if [ "$(docker inspect -f '{{.State.Running}}' blindcheck-frontend 2>/dev/null)" != "true" ]; then
              echo "‚ùå ERROR: El frontend fall√≥ al iniciar. Mostrando logs:"
              docker logs blindcheck-frontend
              exit 1
            fi

            # Verificaci√≥n espec√≠fica para el backend
            # Note: blindcheck-backend might need to be replaced with specific service names if you check them individually
            # But here we just check if it's running if distinct from services defined. 
            # Actually, your docker-compose has 'auth-service', 'student-service', etc.
            # You don't have a container named 'blindcheck-backend'. 
            # I will assume you want to check one of the core services, e.g., auth-service.
            
            if [ "$(docker inspect -f '{{.State.Running}}' blindcheck-auth 2>/dev/null)" != "true" ]; then
              echo "‚ùå ERROR: El Auth Service fall√≥ al iniciar. Mostrando logs:"
              docker logs blindcheck-auth
              exit 1
            fi
            
            echo "‚úÖ Despliegue completado con √©xito."